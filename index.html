<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‹¯æ•‘å¤§é¹½æ¹–éŠæˆ²</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  background-color: #f0f8ff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.game-container {
  text-align: center;
  border: 2px solid #ddd;
  padding: 20px;
  background-color: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  width: 380px;
}

h1 {
  font-size: 24px;
  color: #333;
  margin-bottom: 20px;
}

.lake {
  width: 100%;
  height: 200px;
  background-color: #e0e0e0;
  border: 2px solid #00bfff;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
  border-radius: 5px;
}

.water {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background-color: #b0e0e6;
  transition: height 0.2s ease, background-color 0.5s ease;
}

.controls p {
  font-size: 18px;
  margin: 10px 0;
}

#click-button {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
  background-color: #00bfff;
  border: none;
  border-radius: 5px;
  color: white;
}

#click-button:active {
  background-color: #0099cc;
}

/* å‡ç´š / é¡Œç›® è¦–çª—æ¨£å¼ */
#upgrade-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 50;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 340px;
  text-align: center;
}

.upgrade-option, .answer-option {
  margin: 10px 0;
  padding: 10px;
  background-color: #00bfff;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  width: 100%;
  text-align: left;
}

.upgrade-option:hover, .answer-option:hover {
  background-color: #0099cc;
}

.info-line {
  margin-top: 10px;
  font-size: 14px;
  color: #333;
}

.small-note {
  margin-top: 8px;
  font-size: 13px;
  color: #666;
}
</style>
</head>
<body>
  <div class="game-container">
    <h1>æ‹¯æ•‘ä¹¾æ¶¸çš„å¤§é¹½æ¹–</h1>
    <div class="lake">
      <div class="water" id="water"></div>
    </div>
    <div class="controls">
      <p>æ°´é‡: <span id="water-level">0%</span></p>
      <p>å‰©é¤˜æ™‚é–“: <span id="timer">45</span>ç§’</p>
      <button id="click-button">é»æ“Šæ‹¯æ•‘!</button>
      <p class="small-note">æç¤ºï¼šç­”é¡Œç­”å°å¯ç²å¾—æŠ€èƒ½åŠ æˆæˆ–å•Ÿå‹•è‡ªå‹•æ³¨æ°´ã€‚</p>
    </div>
    <div id="first-correct-msg" class="info-line"></div>
  </div>

  <div id="upgrade-modal">
    <div class="modal-content" id="modal-content">
      <p id="modal-message"></p>
      <div id="upgrade-options"></div>
    </div>
  </div>

<script>
/* ---------- éŠæˆ²åˆå§‹åƒæ•¸ï¼ˆä½ å…ˆå‰æ”¹éçš„ï¼‰ ---------- */
let waterLevel = 0;
let timeLeft = 45;
let clickPower = 0.2;
let autoFillActive = false;
let autoFillRate = 1000;    // æ¯«ç§’
let autoFillChance = 0;     // æ©Ÿç‡ (0~1) ä½¿åŠ é‡è®Šæˆ multiplier
let autoFillMultiplier = 2;
let autoFillTimer = null;

/* DOM */
const water = document.getElementById("water");
const waterLevelDisplay = document.getElementById("water-level");
const timerDisplay = document.getElementById("timer");
const clickButton = document.getElementById("click-button");
const modal = document.getElementById("upgrade-modal");
const modalMessage = document.getElementById("modal-message");
const upgradeOptions = document.getElementById("upgrade-options");
const firstCorrectMsg = document.getElementById("first-correct-msg");

/* å‡ç´šæ¬¡æ•¸é™åˆ¶ */
let upgradeCounts = {
  option1: 0,
  option2: 0,
  option3: 0,
  option4: 0
};

/* è¨ˆæ™‚å™¨å¼•ç”¨ */
let timerInterval = null;

/* è¨˜éŒ„é¡Œç›®èˆ‡éš¨æ©Ÿé…ç½® */
const initialQuestion = {
  id: "q0",
  text: `è«‹å•ä»¥ä¸‹å“ªå€‹è§’è‰²çš„æƒ³æ³•æˆ–æ…‹åº¦æœ€æœ‰åŠ©æ–¼æ¸›ç·©å¤§é¹½æ¹–çš„ç¼ºæ°´å±æ©Ÿ?\nA. è¾²å¤«:é‡åˆ°è±æ°´å¹´æ™‚ï¼Œèªç‚ºè‡ªå·±å¾ˆå¹¸é‹ï¼Œä¸éœ€è¦å†ç¯€ç´„ç”¨æ°´\nB. é’å¹´:å¤§é¹½æ¹–ç¼ºæ°´æ˜¯ä¸Šä¸€ä»£æƒ¹çš„ç¦ï¼Œä»–å€‘è‡ªè¡Œè§£æ±ºå°±å¥½\nC. å·æ”¿åºœ:ç¶­æŒèˆŠæœ‰æ³•å¾‹ï¼Œç¯€çœä¸‹ä¾†çš„æ°´ä¸é ˆå›æµå¤§é¹½æ¹–\nD. ç‰§å ´ä¸»:å’Œå·æ”¿åºœé…åˆï¼ŒæŠ•è³‡æ–°æŠ€è¡“ä»¥ä½¿ç”¨æ›´å°‘çš„æ°´ç¨®æ¤è¾²ä½œç‰©`,
  choices: ["A","B","C","D"],
  correct: "D",
  time: 40
};

/* å››å€‹çŸ¥è­˜é¡Œï¼ˆæœƒåœ¨ 35/25/20/10 éš¨æ©Ÿé †åºå‡ºç¾ï¼‰ */
const knowledgeQuestions = [
  {
    id: "q1",
    text: `ä»¥ä¸‹ä½•è€…å’Œå¤§é¹½æ¹–ç¾ä»Šé¢è‡¨çš„å±æ©Ÿè¼ƒç„¡é—œä¿‚?\nA. å› å…¨çƒæš–åŒ–ï¼Œèå†°å¢åŠ é€ æˆæ°´ä½ä¸Šå‡ä¸”ç ´å£å¤©ç„¶æ»‘é›ªå ´\nB. é¹½åº¦ä¸Šå‡ï¼Œè‡´ä½¿å¤šç¨®å¾®ç”Ÿç‰©ã€è±å¹´è¦ç­‰éƒ½é›£ä»¥ç”Ÿå­˜\nC. æ¹–åºŠä¹¾æ¶¸å°è‡´æ›´å¤šæœ‰æ¯’æ²™å¡µé£›æš\nD. æ°´ä½ä¸‹é™ä½¿å­¤å³¶å’Œå¤§é™¸ç›¸é€£ï¼Œæ•é£Ÿé³¥é¡çš„æ é£Ÿè€…å¾—ä»¥é€²å…¥`,
    choices: ["A","B","C","D"],
    correct: "A"
  },
  {
    id: "q2",
    text: `ä»¥ä¸‹ä½•è€…åœ¨å¤§é¹½æ¹–ç”Ÿæ…‹ç³»ä¸­ä¸¦éæ‰®æ¼”ä¸»è¦è§’è‰²?\nA. æµ®æ¸¸æ¤ç‰©\nB. è±å¹´è¦\nC. é­šé¡\nD. å€™é³¥`,
    choices: ["A","B","C","D"],
    correct: "C"
  },
  {
    id: "q3",
    text: `ä»¥ä¸‹æ•˜è¿°ä½•è€…æ­£ç¢º?\nA. å¤§é¹½æ¹–çš„æ¹–æ°´å¯†åº¦ä¹‹é«˜ï¼Œä½¿äººå€‘å¯ä»¥è¼•æ˜“æµ®åœ¨æ°´ä¸Š\nB. æ•¸é‡é©šäººçš„é¹½æ°´è’¼è …æˆç‚ºå€™é³¥è±å¯Œçš„é£Ÿç‰©ä¾†æº\nC. ä¸åŒæ£µç™½æ¥Šæ¨¹é–“å› èƒ½å…±äº«æ°´è³‡æºï¼Œä½¿æ¨¹ç¾¤æˆç‚ºåœ°çƒä¸Šæœ€å¤§ç”Ÿç‰©é«”ä¹‹ä¸€\nD. å–‡å­å¤©éµæ›¾ä¸€åº¦ç€•è‡¨æ»…çµ•ï¼Œå¦‚ä»Šæœ‰æ•¸è¬éš»ï¼Œæ˜¯å¾©è‚²æˆåŠŸçš„æ¡ˆä¾‹\nE. ä»¥ä¸Šçš†æ˜¯`,
    choices: ["A","B","C","D","E"],
    correct: "E"
  },
  {
    id: "q4",
    text: `ä»¥ä¸‹ä½•è€…æ¶ˆè€—äº†æœ€å¤šå¤§é¹½æ¹–ä¸Šæ¸¸çš„æ°´?\nA. å®¶åº­ç”¨æ°´\nB. è¾²æ¥­\nC. æ¤ç‰©è’¸æ•£ä½œç”¨\nD. å·¥æ¥­`,
    choices: ["A","B","C","D"],
    correct: "B"
  }
];

/* æ±ºå®š 35/25/20/10 æ™‚æ‰€å°æ‡‰çš„é¡Œç›® (éš¨æ©Ÿã€ä¸é‡è¤‡) */
const scheduledTimes = [35,25,20,10];
let scheduledQuestionMap = {}; // time => question obj
(function assignRandomQuestions(){
  const pool = [...knowledgeQuestions];
  // shuffle pool
  for (let i = pool.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }
  scheduledTimes.forEach((t, i) => {
    scheduledQuestionMap[t] = pool[i];
  });
})();

/* åˆ¤æ–·ç©å®¶ç¬¬ä¸€æ¬¡ç­”å°é¡Œç›®çš„æ™‚é–“ï¼ˆå€’æ•¸ç§’æ•¸ï¼‰ */
let firstCorrectAt = null;

/* ---------- DOM æ›´æ–°èˆ‡è‡ªå‹•æ³¨æ°´é‚è¼¯ ---------- */
function updateWaterLevel() {
  if (waterLevel > 100) waterLevel = 100;
  waterLevelDisplay.textContent = `${waterLevel.toFixed(1)}%`;
  water.style.height = `${waterLevel}%`;

  if (waterLevel < 25) water.style.backgroundColor = "#b0e0e6";
  else if (waterLevel < 50) water.style.backgroundColor = "#87ceeb";
  else if (waterLevel < 75) water.style.backgroundColor = "#4682b4";
  else water.style.backgroundColor = "#1e90ff";
}

function startAutoFill() {
  if (autoFillTimer) clearInterval(autoFillTimer);
  autoFillActive = true;
  autoFillTimer = setInterval(() => {
    let addAmount = 1;
    if (Math.random() < autoFillChance) addAmount = autoFillMultiplier;
    waterLevel += addAmount;
    updateWaterLevel();
  }, autoFillRate);
}

function stopAutoFill() {
  if (autoFillTimer) {
    clearInterval(autoFillTimer);
    autoFillTimer = null;
  }
  autoFillActive = false;
}

/* ---------- è¨ˆæ™‚æ§åˆ¶ ---------- */
function pauseTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  // æ³¨æ„ï¼šè‹¥å·²å•Ÿå‹•è‡ªå‹•æ³¨æ°´ï¼Œæ‡‰æš«åœè‡ªå‹•æ³¨æ°´ï¼ˆmodaläº’å‹•æœŸé–“ä¸è‡ªå‹•æ³¨æ°´ï¼‰
  if (autoFillTimer) {
    clearInterval(autoFillTimer);
  }
}

function resumeTimer() {
  // å•Ÿå‹•ä¸»å€’æ•¸ï¼ˆå¦‚æœå°šæœªå•Ÿå‹•ï¼‰
  if (!timerInterval) startTimer();
  // æ¢å¾©è‡ªå‹•æ³¨æ°´ï¼ˆè‹¥ previously activeï¼‰
  if (autoFillActive) {
    startAutoFill();
  }
}

/* ---------- å‡ç´šé¸å–®ï¼ˆèˆ‡ä½ åŸå…ˆé‚è¼¯ä¸€è‡´ï¼‰ ---------- */
function showUpgradeMenu() {
  modal.style.display = "flex";
  modalMessage.textContent = "é¸æ“‡ä¸€é …å‡ç´š";
  upgradeOptions.innerHTML = "";

  if (upgradeCounts.option1 < 2)
    addUpgradeOption("æ³¨æ°´é‡ä¸Šå‡ï¼ˆæå‡é»æ“Šå¢åŠ é‡ï¼‰", "option1");
  if (upgradeCounts.option2 < 2)
    addUpgradeOption("è‡ªå‹•æ³¨æ°´é »ç‡ä¸Šå‡ï¼ˆæ›´å¿«æ³¨æ°´ï¼‰", "option2");
  if (upgradeCounts.option3 < 2)
    addUpgradeOption("è‡ªå‹•æ³¨æ°´é‡åŠ å€ä¹‹æ©Ÿç‡ä¸Šå‡ï¼ˆæœ‰æ©Ÿæœƒå€å¢ï¼‰", "option3");
  if (upgradeCounts.option3 > 0 && upgradeCounts.option4 < 1)
    addUpgradeOption("è‡ªå‹•æ³¨æ°´å€ç‡ä¸Šå‡ï¼ˆæŠŠå€å¢æ”¹ç‚ºæ›´é«˜ï¼‰", "option4");
}

function addUpgradeOption(text, optionKey) {
  const btn = document.createElement("button");
  btn.className = "upgrade-option";
  btn.textContent = text;
  btn.onclick = () => {
    selectUpgrade(optionKey);
  };
  upgradeOptions.appendChild(btn);
}

function selectUpgrade(optionKey) {
  upgradeCounts[optionKey]++;
  if (optionKey === "option1") {
    // ä¾åºæå‡ï¼š 0.2 -> 0.3 -> 0.4
    if (clickPower < 0.3) clickPower = 0.3;
    else clickPower = 0.4;
  } else if (optionKey === "option2") {
    if (autoFillRate === 1000) autoFillRate = 800;
    else autoFillRate = 600;
    if (autoFillActive) startAutoFill();
  } else if (optionKey === "option3") {
    if (autoFillChance === 0) autoFillChance = 0.25;
    else autoFillChance = 0.5;
  } else if (optionKey === "option4") {
    autoFillMultiplier = 3;
  }
  // é¸å®Œå‡ç´šå¾Œé—œé–‰modalä¸¦ç¹¼çºŒè¨ˆæ™‚
  modal.style.display = "none";
  resumeTimer();
}

/* ---------- é¡Œç›®é¡¯ç¤º/åˆ¤æ–·ï¼ˆå« 40 ç§’ç‰¹æ®Šé¡Œï¼‰ ---------- */
function showQuestionModal(questionObj, timeOfQuestion) {
  // æš«åœä¸»è¨ˆæ™‚èˆ‡è‡ªå‹•æ³¨æ°´
  pauseTimer();
  modal.style.display = "flex";
  modalMessage.textContent = questionObj.text.replace(/\n/g, "<br>");
  upgradeOptions.innerHTML = "";

  // Create answer buttons
  questionObj.choices.forEach(choice => {
    const btn = document.createElement("button");
    btn.className = "answer-option";
    btn.textContent = choice + (choice.length === 1 ? "" : "");
    btn.onclick = () => {
      handleAnswer(choice, questionObj, timeOfQuestion);
    };
    upgradeOptions.appendChild(btn);
  });
}

/* åˆ¤æ–·ç©å®¶ç­”æ¡ˆ */
function handleAnswer(selected, questionObj, timeOfQuestion) {
  const correct = questionObj.correct;
  const wasCorrect = (selected === correct);

  // è‹¥é‚„æ²’æœ‰ç¬¬ä¸€æ¬¡ç­”å°ç´€éŒ„ï¼Œä¸”æœ¬æ¬¡ç­”å°ï¼Œè¨˜éŒ„ä¸¦ä¸”ï¼ˆå¦‚æœå°šæœªæœ‰ autoFillActiveï¼‰å•Ÿå‹• autoFill
  if (wasCorrect && firstCorrectAt === null) {
    firstCorrectAt = timeOfQuestion;
    firstCorrectMsg.textContent = `ä½ ç¬¬ä¸€æ¬¡ç­”å°é¡Œç›®æ˜¯åœ¨å€’æ•¸ ${timeOfQuestion} ç§’æ™‚ã€‚`;
    // å¦‚æœå°šæœªå•Ÿå‹•è‡ªå‹•æ³¨æ°´ï¼Œå‰‡çµ¦äºˆã€Œç²å¾—æ–°æ©Ÿå™¨ï¼Œå¯è‡ªå‹•æ³¨æ°´ã€æ•ˆæœèˆ‡å•Ÿå‹•ï¼ˆ1 ç§’å¾Œï¼‰
    if (!autoFillActive) {
      // é¡¯ç¤ºçŸ­è¨Šæ¯ï¼Œå»¶é² 1 ç§’å¾Œå•Ÿå‹•
      upgradeOptions.innerHTML = "";
      modalMessage.textContent = "ç²å¾—æ–°æ©Ÿå™¨ï¼Œå¯è‡ªå‹•æ³¨æ°´ï¼";
      setTimeout(() => {
        modal.style.display = "none";
        startAutoFill();
        resumeTimer();
        // è‹¥ç­”å°çš„æ˜¯ 40 ç§’é¡Œï¼ˆåŸæœ¬ä¹Ÿéœ€è¦åœ¨ 40 åˆ¤æ–·ï¼‰ï¼Œæˆ‘å€‘å·²åœ¨é€™è£¡è™•ç†
      }, 1000);
      return;
    }
    // else å¦‚æœ auto å·²ç¶“ activeï¼ˆä¸å¤ªå¯èƒ½ï¼‰ï¼Œç¹¼çºŒåˆ°çµ¦äºˆå‡ç´šé¸å–®æ­¥é©Ÿ
  }

  // è‹¥ç©å®¶ç­”å°ä¸” firstCorrectAt å·²å­˜åœ¨ï¼ˆæˆ–å‰›æ‰ä¸æ˜¯ç¬¬ä¸€æ¬¡ï¼Œä½† autoFill å·²å•Ÿç”¨ï¼‰ï¼Œ
  // è¦é¡¯ç¤ºå‡ç´šé¸å–®ï¼ˆåŸå…ˆåœ¨é‚£äº›æ™‚é–“é»æœƒå‡ºç¾å‡ç´šçš„è¡Œç‚ºï¼‰ã€‚
  if (wasCorrect) {
    // é¡¯ç¤ºå‡ç´šé¸å–® (åªæœ‰åœ¨ç­”å°æ™‚)
    showUpgradeMenu();
  } else {
    // ç­”éŒ¯ -> ç›´æ¥é—œé–‰ modal ä¸¦ç¹¼çºŒï¼ˆä¸é¡¯ç¤ºå‡ç´šï¼‰
    modal.style.display = "none";
    resumeTimer();
  }
}

/* ---------- ä¸»å€’æ•¸è¨ˆæ™‚ ---------- */
function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = timeLeft;

    // 40 ç§’ç‰¹æ®Šé¡Œï¼ˆinitialQuestionï¼‰
    if (timeLeft === initialQuestion.time) {
      // é¡¯ç¤º initial question modalï¼ˆ40 ç§’ï¼‰
      showQuestionModal(initialQuestion, initialQuestion.time);
    }

    // 35/25/20/10 æ™‚ï¼Œé¡¯ç¤ºéš¨æ©Ÿåˆ†é…çš„çŸ¥è­˜é¡Œ
    if (scheduledQuestionMap.hasOwnProperty(timeLeft)) {
      const qobj = scheduledQuestionMap[timeLeft];
      showQuestionModal(qobj, timeLeft);
    }

    // éŠæˆ²çµæŸæ¢ä»¶
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      if (autoFillTimer) {
        clearInterval(autoFillTimer);
        autoFillTimer = null;
      }
      clickButton.disabled = true;
      const msg = document.createElement("p");
      msg.textContent = `ğŸŒŠ éŠæˆ²çµæŸï¼ä½ çš„æœ€çµ‚æ°´ä½æ˜¯ ${waterLevel.toFixed(1)}%`;
      document.querySelector(".game-container").appendChild(msg);
    }
  }, 1000);
}

/* ---------- é»æ“Šäº‹ä»¶ ---------- */
clickButton.addEventListener("click", () => {
  if (waterLevel < 100) {
    waterLevel += clickPower;
    updateWaterLevel();
  }
});

/* ---------- åˆå§‹åŒ– ---------- */
updateWaterLevel();
startTimer();

</script>
</body>
</html>
